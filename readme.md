# конфигурация terraform для развертки Wordpress на Cloud.ru

## Фичи
1) развертка с одной команды
2) разворачивается все на ECC
3) автоматически инсталируются все необходимые расширения для CCE
4) Wordpress разворачивается с подключенным автоскалированием и ELB
5) создается автоматически проект (если не указан ``enterprise_project_id`` в ``terraform.tfvars``)

## Как развернуть?
1) нужно иметь доступ к облаку advanced от cloud.ru (только с таким терраформ и заработает)
2) в облаке создаем сервисный аккаунт, сохраняем оттуда access key и secret key
3) забираем id нашего аккаунта (заходим в my credentials, и там будет Project ID)
4) копируем этот репо, переходим в папку infrastructure и создаем там файл ``terraform.tfvars`` со следующим содержимым:
```
access_key = <вставляем account access key>
secret_key = <вставляем account secret key>
account_id = <вставляем id аккаунта из шага 3>
enterprise_project_id = <если проект был создан - вставляем сюда ID, иначе эту строку удаляем из файла>
```
5) делаем ``terraform init``
6) далее делаем ``terraform apply``
7) в output должны упасть все данные для подключения (логины и пароли от wp), 
данные для подключения к k8s кластеру и т.д.

## Как проверить автоскалирование?
1) переходим в папку ``load_tests``
2) в файле ``load.yaml`` везде заменяем ip адрес на публичный адрес развернутого wordpress (его берем из terraform output)
3) и далее делаем ``docker compose up``
4) команда запустит докер и в нем yandex tank на нагрузочные тесты на 5 минут
5) в панели cloud.ru на странице cce, в deployment wordpress можно посмотреть, как будут добавляться pod'ы с wordpress по мере работы нагрузочного теста

## Что из важного
1) wordpress отдельно не тюнился, чтобы выдерживать большие нагрузки, 
но из коробки доступен плагин для кеширования (кеширует запросы к СУБД в memcached). Сделать супер-отказоустойчивую конфигурацию задачи не было
2) развернуть RDS на MySQL взамен тому, что в k8s - не получится, у cloud.ru есть баг с разверткой RDS на MySQL (связан с вызовом несуществующего API в самом провайдере в terraform)
3) Не рекомендуется ставить отдельные подсети на worker node pool для ``subnet_id`` и ``eni_subnet_id`` - иначе можно получить 
worker node pool в вечном состоянии installing. Связано с тем, что для ``eni_subnet_id`` создается автоматически security group с нужными правами на трафик, 
а для ``subnet_id`` - нет, поэтому на ноды под worker node pool не получается ничего установить, ввиду просто отсутствия подключения
